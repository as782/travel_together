import{O as Z,bp as N,ak as ee,d as T,a9 as ae,b5 as le,b as r,I as R,aV as te,bk as E,a0 as ne,an as re,a7 as x,r as F,x as ie,U as oe,b1 as se,X as j,ab as P,ac as U,aN as ue,V as D,W as O,bq as ce,ag as C,af as de,t as fe,J as ve,a1 as me,ay as _,br as M}from"./index-Al1ESLyH.js";import"./index-BFdtbEqF.js";import{I as ge}from"./index-o3mCI9mj.js";import{s as pe}from"./function-call-CNCgHTtt.js";const[we,i,be]=Z("uploader");function B(e,t){return new Promise(o=>{if(t==="file"){o();return}const u=new FileReader;u.onload=v=>{o(v.target.result)},t==="dataUrl"?u.readAsDataURL(e):t==="text"&&u.readAsText(e)})}function $(e,t){return N(e).some(o=>o.file?ee(t)?t(o.file):o.file.size>+t:!1)}function he(e,t){const o=[],u=[];return e.forEach(v=>{$(v,t)?u.push(v):o.push(v)}),{valid:o,invalid:u}}const ye=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,ke=e=>ye.test(e);function q(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?ke(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var Ie=T({props:{name:ae,item:le(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:t,slots:o}){const u=()=>{const{status:n,message:f}=e.item;if(n==="uploading"||n==="failed"){const m=n==="failed"?r(R,{name:"close",class:i("mask-icon")},null):r(te,{class:i("loading")},null),d=ne(f)&&f!=="";return r("div",{class:i("mask")},[m,d&&r("div",{class:i("mask-message")},[f])])}},v=n=>{const{name:f,item:m,index:d,beforeDelete:k}=e;n.stopPropagation(),re(k,{args:[m,{name:f,index:d}],done:()=>t("delete")})},g=()=>t("preview"),y=()=>t("reupload"),p=()=>{if(e.deletable&&e.item.status!=="uploading"){const n=o["preview-delete"];return r("div",{role:"button",class:i("preview-delete",{shadow:!n}),tabindex:0,"aria-label":be("delete"),onClick:v},[n?n():r(R,{name:"cross",class:i("preview-delete-icon")},null)])}},h=()=>{if(o["preview-cover"]){const{index:n,item:f}=e;return r("div",{class:i("preview-cover")},[o["preview-cover"](x({index:n},f))])}},I=()=>{const{item:n,lazyLoad:f,imageFit:m,previewSize:d,reupload:k}=e;return q(n)?r(ge,{fit:m,src:n.objectUrl||n.content||n.url,class:i("preview-image"),width:Array.isArray(d)?d[0]:d,height:Array.isArray(d)?d[1]:d,lazyLoad:f,onClick:k?y:g},{default:h}):r("div",{class:i("file"),style:E(e.previewSize)},[r(R,{class:i("file-icon"),name:"description"},null),r("div",{class:[i("file-name"),"van-ellipsis"]},[n.file?n.file.name:n.url]),h()])};return()=>r("div",{class:i("preview")},[I(),u(),p()])}});const Pe={name:j(""),accept:P("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:j(1/0),imageFit:P("cover"),resultType:P("dataUrl"),uploadIcon:P("photograph"),uploadText:String,deletable:U,reupload:Boolean,afterRead:Function,showUpload:U,modelValue:ue(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:U,previewOptions:Object,previewFullImage:U,maxSize:{type:[Number,String,Function],default:1/0}};var Ue=T({name:we,props:Pe,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:t,slots:o}){const u=F(),v=[],g=F(-1),y=F(!1),p=(a=e.modelValue.length)=>({name:e.name,index:a}),h=()=>{u.value&&(u.value.value="")},I=a=>{if(h(),$(a,e.maxSize))if(Array.isArray(a)){const l=he(a,e.maxSize);if(a=l.valid,t("oversize",l.invalid,p()),!a.length)return}else{t("oversize",a,p());return}if(a=ve(a),g.value>-1){const l=[...e.modelValue];l.splice(g.value,1,a),t("update:modelValue",l),g.value=-1}else t("update:modelValue",[...e.modelValue,...N(a)]);e.afterRead&&e.afterRead(a,p())},n=a=>{const{maxCount:l,modelValue:c,resultType:s}=e;if(Array.isArray(a)){const w=+l-c.length;a.length>w&&(a=a.slice(0,w)),Promise.all(a.map(b=>B(b,s))).then(b=>{const Q=a.map((A,S)=>{const L={file:A,status:"",message:"",objectUrl:URL.createObjectURL(A)};return b[S]&&(L.content=b[S]),L});I(Q)})}else B(a,s).then(w=>{const b={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};w&&(b.content=w),I(b)})},f=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const c=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(c,p());if(!s){h();return}if(ce(s)){s.then(w=>{n(w||c)}).catch(h);return}}n(c)};let m;const d=()=>t("closePreview"),k=a=>{if(e.previewFullImage){const l=e.modelValue.filter(q),c=l.map(s=>(s.objectUrl&&!s.url&&s.status!=="failed"&&(s.url=s.objectUrl,v.push(s.url)),s.url)).filter(Boolean);m=pe(x({images:c,startPosition:l.indexOf(a),onClose:d},e.previewOptions))}},G=()=>{m&&m.close()},X=(a,l)=>{const c=e.modelValue.slice(0);c.splice(l,1),t("update:modelValue",c),t("delete",a,p(l))},J=a=>{y.value=!0,g.value=a,fe(()=>z())},W=()=>{y.value||(g.value=-1),y.value=!1},Y=(a,l)=>{const c=["imageFit","deletable","reupload","previewSize","beforeDelete"],s=x(C(e,c),C(a,c,!0));return r(Ie,de({item:a,index:l,onClick:()=>t(e.reupload?"clickReupload":"clickPreview",a,p(l)),onDelete:()=>X(a,l),onPreview:()=>k(a),onReupload:()=>J(l)},C(e,["name","lazyLoad"]),s),C(o,["preview-cover","preview-delete"]))},H=()=>{if(e.previewImage)return e.modelValue.map(Y)},V=a=>t("clickUpload",a),K=()=>{if(e.modelValue.length>=+e.maxCount&&!e.reupload)return;const a=e.modelValue.length>=+e.maxCount&&e.reupload,l=e.readonly?null:r("input",{ref:u,type:"file",class:i("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&g.value===-1,disabled:e.disabled,onChange:f,onClick:W},null);return o.default?D(r("div",{class:i("input-wrapper"),onClick:V},[o.default(),l]),[[O,!a]]):D(r("div",{class:i("upload",{readonly:e.readonly}),style:E(e.previewSize),onClick:V},[r(R,{name:e.uploadIcon,class:i("upload-icon")},null),e.uploadText&&r("span",{class:i("upload-text")},[e.uploadText]),l]),[[O,e.showUpload&&!a]])},z=()=>{u.value&&!e.disabled&&u.value.click()};return ie(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),oe({chooseFile:z,closeImagePreview:G}),se(()=>e.modelValue),()=>r("div",{class:i()},[r("div",{class:i("wrapper",{disabled:e.disabled})},[H(),K()])])}});const Ve=me(Ue),ze=(e,t)=>_.post(`/upload/avatar/${t}`,e,{headers:{"Content-Type":M.form_data}}),Ae=e=>_.post(`/upload/${e.flag}/${e.username}`,e.filedata,{headers:{"Content-Type":M.form_data}});export{Ve as U,Ae as a,ze as u};
